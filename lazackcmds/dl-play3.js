import yts from 'yt-search';

let handler = async (m, { conn, args }) => {
    if (!args[0]) return conn.reply(m.chat, `*PLEASE ENTER A SEARCH QUERY*`, m);

    await m.react('‚è≥');
    try {
        let searchResults = await search(args.join(" "));

        if (!searchResults || searchResults.length === 0) {
            throw new Error('No videos found.');
        }

        let video = searchResults.find(v => v.seconds < 3600) || searchResults[0];

        let messageText = `üåü *YouTube Playback* üåü\n\n`;
        messageText += `üé¨ *Title:* ${video.title}\n`;
        messageText += `‚è∞ *Duration:* ${formatDuration(video.seconds)}\n`;
        messageText += `üë§ *Author:* ${video.author.name || 'Unknown'}\n`;
        messageText += `üìÖ *Published:* ${convertTimeToEnglish(video.ago)}\n`;
        messageText += `üëÄ *Views:* ${video.views.toLocaleString()}\n`;
        messageText += `üîó *Direct link:* ${video.url}\n`;

        let image = video.image || 'default-image-url';

        await conn.sendButton2(
            m.chat,
            messageText,
            'WhatsApp Bot',
            image,
            [
                ['üé∂ MP3', `.ytmp3 ${video.url}`],
                ['üì∫ MP4', `.ytmp4 ${video.url}`],
                ['üé∂ MP3DOC', `.ytmp3doc ${video.url}`],
                ['üì∫ MP4DOC', `.ytmp4doc ${video.url}`]
            ],
            '',
            [],
            m,
            {}
        );

        await m.react('‚úÖ');
    } catch (error) {
        console.error(error);
        await m.react('‚ùå');
        conn.reply(m.chat, '*`AN ERROR OCCURRED.`*', m);
    }
};

handler.help = ['play *<text>*'];
handler.tags = ['dl'];
handler.command = ['play3'];

export default handler;

async function search(query, options = {}) {
    let search = await yts.search({ query, hl: "en", gl: "US", ...options });
    return search.videos;
}

function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secondsLeft = Math.floor(seconds % 60);
    return `${hours > 0 ? hours + 'h ' : ''}${minutes}m ${secondsLeft}s`;
}

function convertTimeToEnglish(timeText) {
    if (!timeText || typeof timeText !== 'string') {
        return 'Unknown date';
    }
    return timeText
        .replace(/a√±o/g, 'year').replace(/a√±os/g, 'years')
        .replace(/mes/g, 'month').replace(/meses/g, 'months')
        .replace(/d√≠a/g, 'day').replace(/d√≠as/g, 'days')
        .replace(/hora/g, 'hour').replace(/horas/g, 'hours')
        .replace(/minuto/g, 'minute').replace(/minutos/g, 'minutes');
}
